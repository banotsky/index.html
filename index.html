<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Project Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: Arial; background:#f2f4f7; padding:20px; }
    .hidden { display:none; }
    .card { background:#fff; padding:15px; margin-bottom:10px; border-left:5px solid #0d6efd; }
    button { padding:6px 10px; margin:3px 0; }
    input, select { width:100%; padding:6px; margin-bottom:8px; }
  </style>
</head>
<body>

<div id="login">
  <h2>Login</h2>
  <select id="role">
    <option value="ceo">CEO</option>
    <option value="manager">Manager</option>
    <option value="expediter">Expediter</option>
  </select>
  <button onclick="login()">Login</button>
</div>

<div id="ceo" class="hidden">
  <h2>CEO Dashboard</h2>
  <button onclick="logout()">Logout</button>
  <div id="ceoProjects"></div>
</div>

<div id="manager" class="hidden">
  <h2>Manager Dashboard</h2>
  <button onclick="logout()">Logout</button>
  <div id="managerProjects"></div>
  <button onclick="showForm()">Create Project</button>
</div>

<div id="expediter" class="hidden">
  <h2>Expediter Dashboard</h2>
  <button onclick="logout()">Logout</button>
  <div id="expediterProjects"></div>
</div>

<div id="form" class="hidden">
  <h3 id="formTitle">Create Project</h3>
  <input id="pName" placeholder="Project Name" />
  <input id="pLocation" placeholder="Location" />
  <input id="pBudget" type="number" placeholder="Budget" />
  <input id="pStart" type="date" />
  <input id="pTarget" type="date" />
  <input id="pStatus" placeholder="Status" />
  <button onclick="saveProject()">Save</button>
</div>

<script>
window.addEventListener("load", function () {

  const supabaseClient = window.supabase.createClient(
    "https://qybnvniuifdbxyhyjarn.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5Ym52bml1aWZkYnh5aHlqYXJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NDQ2MTQsImV4cCI6MjA4NjMyMDYxNH0.gr7LlCjcJjs57FiSSiwXY05YB8xZms-RG9iHvg98K1o"
  );

  let editId = null;

  window.login = function () {
    localStorage.setItem("role", document.getElementById("role").value);
    render();
  };

  window.logout = function () {
    localStorage.removeItem("role");
    location.reload();
  };

  window.showForm = function () {
    editId = null;
    clearForm();
    document.getElementById("formTitle").innerText = "Create Project";
    document.getElementById("form").classList.remove("hidden");
  };

  window.saveProject = async function () {

    const payload = {
      name: pName.value,
      location: pLocation.value,
      budget: pBudget.value,
      start: pStart.value,
      target: pTarget.value,
      status: pStatus.value
    };

    if (editId !== null) {
      await supabaseClient.from("projects").update(payload).eq("id", editId);
      editId = null; // IMPORTANT FIX
    } else {
      await supabaseClient.from("projects").insert(payload);
    }

    document.getElementById("form").classList.add("hidden");
    clearForm();
    render();
  };

  window.editProject = async function (id) {
    const { data } = await supabaseClient
      .from("projects")
      .select("*")
      .eq("id", id)
      .single();

    editId = id;

    document.getElementById("formTitle").innerText = "Edit Project";
    pName.value = data.name;
    pLocation.value = data.location;
    pBudget.value = data.budget;
    pStart.value = data.start;
    pTarget.value = data.target;
    pStatus.value = data.status;

    document.getElementById("form").classList.remove("hidden");
  };

  window.deleteProject = async function (id) {
    if (!confirm("Delete this project?")) return;
    await supabaseClient.from("projects").delete().eq("id", id);
    render();
  };

  async function getProjects() {
    const { data } = await supabaseClient.from("projects").select("*");
    return data || [];
  }

  async function render() {
    document.getElementById("login").classList.add("hidden");
    document.getElementById("ceo").classList.add("hidden");
    document.getElementById("manager").classList.add("hidden");
    document.getElementById("expediter").classList.add("hidden");

    const role = localStorage.getItem("role");

    if (!role) {
      document.getElementById("login").classList.remove("hidden");
      return;
    }

    document.getElementById(role).classList.remove("hidden");

    const projects = await getProjects();

    if (role === "ceo") {
      ceoProjects.innerHTML = "";
      projects.forEach(p => {
        ceoProjects.innerHTML += `<div class="card">${p.name} - ${p.budget}</div>`;
      });
    }

    if (role === "manager") {
      managerProjects.innerHTML = "";
      projects.forEach(p => {
        managerProjects.innerHTML += `
          <div class="card">
            ${p.name} - ${p.budget}<br>
            <button onclick="editProject('${p.id}')">Edit</button>
            <button onclick="deleteProject('${p.id}')">Delete</button>
          </div>`;
      });
    }

    if (role === "expediter") {
      expediterProjects.innerHTML = "";
      for (const p of projects) {
        const { data: expenses } = await supabaseClient
          .from("expenses")
          .select("*")
          .eq("project_id", p.id);

        let total = 0;
        expenses?.forEach(e => total += Number(e.amount));

        expediterProjects.innerHTML += `
          <div class="card">
            ${p.name}<br>
            Budget: ${p.budget}<br>
            Total: ${total}<br>
            Remaining: ${p.budget - total}<br>
            <input id="exp-${p.id}" type="number" placeholder="Expense">
            <button onclick="addExpense('${p.id}')">Add</button>
          </div>`;
      }
    }
  }

  window.addExpense = async function (projectId) {
    const amount = Number(document.getElementById(`exp-${projectId}`).value);
    if (!amount) return;

    await supabaseClient.from("expenses").insert({
      project_id: projectId,
      amount: amount
    });

    render();
  };

  function clearForm() {
    pName.value = "";
    pLocation.value = "";
    pBudget.value = "";
    pStart.value = "";
    pTarget.value = "";
    pStatus.value = "";
  }

  render();
});
</script>

</body>
</html>

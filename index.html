<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>MTP Marine Services - Project Monitoring</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  font-family:Arial;
  margin:0;
  background:#f4f6f9;
}

header{
  background:#0d47a1;
  color:white;
  padding:15px;
  text-align:center;
}

.logo{
  width:100px;
  display:block;
  margin:0 auto 10px auto;
}

.container{
  padding:15px;
}

.card{
  background:white;
  padding:15px;
  margin-bottom:15px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}

button{
  padding:6px 10px;
  margin:3px 0;
  border:none;
  border-radius:4px;
  cursor:pointer;
  background:#0d47a1;
  color:white;
}

input,select{
  padding:6px;
  margin:3px 0;
  width:100%;
}

.positive{color:green;}
.negative{color:red;}

.hidden{display:none;}
</style>
</head>

<body>

<header>
  <img src="logo.jpg" class="logo">
  <h2>MTP Marine Services</h2>
  <div id="userInfo"></div>
  <button onclick="logout()">Logout</button>
</header>

<div class="container">

<div id="loginBox">
  <h3>Login</h3>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<div id="dashboard" class="hidden">

  <div id="manager" class="hidden">
    <h3>Create Project</h3>
    <input id="pname" placeholder="Project Name">
    <input id="plocation" placeholder="Location">
    <input id="pstart" type="date">
    <input id="ptarget" type="date">
    <input id="prevenue" type="number" placeholder="Revenue">
    <button onclick="addProject()">Add Project</button>
  </div>

  <div id="projects"></div>

</div>

</div>

<script>
const supabase = window.supabase.createClient(
"https://qybnvniuifdbxyhyjarn.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5Ym52bml1aWZkYnh5aHlqYXJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NDQ2MTQsImV4cCI6MjA4NjMyMDYxNH0.gr7LlCjcJjs57FiSSiwXY05YB8xZms-RG9iHvg98K1o"
);

let currentUser=null;
let currentRole=null;

async function login(){
  const email=document.getElementById("email").value;
  const password=document.getElementById("password").value;

  const {data,error}=await supabase.auth.signInWithPassword({
    email,password
  });

  if(error){alert(error.message);return;}

  loadUser();
}

async function loadUser(){
  const {data:{user}}=await supabase.auth.getUser();
  if(!user)return;

  currentUser=user;

  const {data}=await supabase
    .from("profiles")
    .select("role")
    .eq("id",user.id)
    .single();

  currentRole=data.role;

  document.getElementById("loginBox").classList.add("hidden");
  document.getElementById("dashboard").classList.remove("hidden");
  document.getElementById("userInfo").innerText=
    user.email+" ("+currentRole+")";

  document.getElementById("manager").classList.add("hidden");
  if(currentRole==="manager")
    document.getElementById("manager").classList.remove("hidden");

  render();
}

async function logout(){
  await supabase.auth.signOut();
  location.reload();
}

async function addProject(){
  await supabase.from("projects").insert({
    name:pname.value,
    location:plocation.value,
    start:pstart.value,
    target:ptarget.value,
    revenue:Number(prevenue.value)
  });
  render();
}

async function deleteProject(id){
  if(!confirm("Delete project?"))return;
  await supabase.from("projects").delete().eq("id",id);
  render();
}

async function editProject(id){
  const name=prompt("New name:");
  if(!name)return;
  await supabase.from("projects").update({name}).eq("id",id);
  render();
}

async function addExpense(pid){
  const amount=Number(document.getElementById("exp-"+pid).value);
  const category=document.getElementById("cat-"+pid).value;

  await supabase.from("expenses").insert({
    project_id:pid,
    amount,
    category
  });
  render();
}

async function deleteExpense(id){
  await supabase.from("expenses").delete().eq("id",id);
  render();
}

async function render(){
  const {data:projects}=await supabase.from("projects").select("*");
  const {data:expenses}=await supabase.from("expenses").select("*");

  const container=document.getElementById("projects");
  container.innerHTML="";

  projects.forEach(p=>{
    const exp=expenses.filter(e=>e.project_id===p.id);
    const totalExp=exp.reduce((a,b)=>a+b.amount,0);
    const profit=p.revenue-totalExp;
    const margin=p.revenue?((profit/p.revenue)*100).toFixed(2):0;

    let expenseHTML="";
    exp.forEach(e=>{
      expenseHTML+=`
        <div>
          ${e.category}: ${e.amount}
          ${currentRole==="expediter"
            ? `<button onclick="deleteExpense('${e.id}')">X</button>`
            : ""}
        </div>`;
    });

    container.innerHTML+=`
    <div class="card">
      <strong>${p.name}</strong><br>
      Location: ${p.location||"-"}<br>
      Revenue: ${p.revenue}<br>
      Expenses: ${totalExp}<br>
      Profit:
      <span class="${profit<0?'negative':'positive'}">${profit}</span><br>
      Margin:
      <span class="${margin<0?'negative':'positive'}">${margin}%</span>
      <hr>
      ${expenseHTML||"No expenses"}

      ${currentRole==="expediter"?`
        <hr>
        <select id="cat-${p.id}">
          <option>Materials</option>
          <option>Labor</option>
          <option>Transport</option>
          <option>Equipment</option>
          <option>Misc</option>
        </select>
        <input id="exp-${p.id}" type="number" placeholder="Amount">
        <button onclick="addExpense('${p.id}')">Add Expense</button>
      `:""}

      ${currentRole==="manager"?`
        <hr>
        <button onclick="editProject('${p.id}')">Edit</button>
        <button onclick="deleteProject('${p.id}')">Delete</button>
      `:""}
    </div>
    `;
  });
}

loadUser();
</script>

</body>
</html>

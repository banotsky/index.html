<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>MTP Marine Services - Project Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { margin:0; font-family:Arial; background:#f4f7fb; }
    .navbar {
      background: linear-gradient(90deg,#0b3d91,#125cc0);
      color:white; padding:15px 25px;
      display:flex; justify-content:space-between; align-items:center;
    }
    .nav-left { display:flex; align-items:center; gap:15px; }
    .nav-left img { height:65px; }
    .nav-title { font-size:22px; font-weight:bold; }
    .container { padding:25px; }
    .hidden { display:none; }
    .card {
      background:white; padding:20px; margin-bottom:20px;
      border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.08);
      border-left:6px solid #0b3d91;
    }
    button {
      padding:7px 12px; margin:5px 4px;
      border:none; border-radius:6px;
      cursor:pointer; background:#0b3d91; color:white;
    }
    button:hover { opacity:0.9; }
    input, select {
      width:100%; padding:8px; margin-bottom:10px;
      border-radius:6px; border:1px solid #ccc;
    }
    .negative { color:red; font-weight:bold; }
    .positive { color:green; font-weight:bold; }
    .login-box {
      max-width:400px; margin:80px auto;
      background:white; padding:30px;
      border-radius:12px;
      box-shadow:0 6px 20px rgba(0,0,0,0.15);
      text-align:center;
    }
  </style>
</head>
<body>

<div class="navbar hidden" id="mainNav">
  <div class="nav-left">
    <img src="logo.jpg">
    <div class="nav-title">MTP Marine Services</div>
  </div>
  <button onclick="logout()">Logout</button>
</div>

<div id="login">
  <div class="login-box">
    <h2>Login</h2>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button onclick="login()">Login</button>
    <p id="errorMsg" style="color:red;"></p>
  </div>
</div>

<div class="container hidden" id="ceo">
  <h2>CEO Dashboard</h2>
  <div id="ceoSummary"></div>
  <div id="ceoProjects"></div>
</div>

<div class="container hidden" id="manager">
  <h2>Manager Dashboard</h2>
  <button onclick="showForm()">Create Project</button>
  <div id="managerProjects"></div>
</div>

<div class="container hidden" id="expediter">
  <h2>Expediter Dashboard</h2>
  <div id="expediterProjects"></div>
</div>

<div class="container hidden" id="form">
  <h3 id="formTitle">Create Project</h3>
  <input id="pName" placeholder="Project Name (Required)" />
  <input id="pLocation" placeholder="Location" />
  <input id="pBudget" type="number" placeholder="Project Revenue" />
  <input id="pStart" type="date" />
  <input id="pTarget" type="date" />
  <input id="pStatus" placeholder="Status" />
  <button onclick="saveProject()">Save</button>
</div>

<script>
window.addEventListener("load", function () {

  const supabaseClient = window.supabase.createClient(
    "https://qybnvniuifdbxyhyjarn.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5Ym52bml1aWZkYnh5aHlqYXJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NDQ2MTQsImV4cCI6MjA4NjMyMDYxNH0.gr7LlCjcJjs57FiSSiwXY05YB8xZms-RG9iHvg98K1o"
  );

  function formatPeso(value) {
    return "₱" + Number(value || 0).toLocaleString("en-PH", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }

  let currentRole = null;
  let editId = null;

  window.login = async function () {
    const { error } = await supabaseClient.auth.signInWithPassword({
      email: email.value,
      password: password.value
    });
    if (error) {
      errorMsg.innerText = error.message;
      return;
    }
    loadUser();
  };

  window.logout = async function () {
    await supabaseClient.auth.signOut();
    location.reload();
  };

  async function loadUser() {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) {
      document.getElementById("login").classList.remove("hidden");
      return;
    }

    document.getElementById("mainNav").classList.remove("hidden");

    const { data } = await supabaseClient
      .from("profiles")
      .select("role")
      .eq("id", user.id)
      .single();

    currentRole = data.role;
    render();
  }

  window.showForm = function () {
    editId = null;
    clearForm();
    document.getElementById("formTitle").innerText = "Create Project";
    document.getElementById("form").classList.remove("hidden");
  };

  window.saveProject = async function () {
    if (!pName.value.trim()) {
      alert("Project name is required");
      return;
    }

    const payload = {
      name: pName.value.trim(),
      location: pLocation.value || null,
      budget: pBudget.value || null,
      start: pStart.value || null,
      target: pTarget.value || null,
      status: pStatus.value || null
    };

    if (editId) {
      await supabaseClient.from("projects").update(payload).eq("id", editId);
      editId = null;
    } else {
      await supabaseClient.from("projects").insert(payload);
    }

    document.getElementById("form").classList.add("hidden");
    clearForm();
    render();
  };

  window.editProject = async function (id) {
    const { data } = await supabaseClient
      .from("projects")
      .select("*")
      .eq("id", id)
      .single();

    editId = id;
    pName.value = data.name || "";
    pLocation.value = data.location || "";
    pBudget.value = data.budget || "";
    pStart.value = data.start || "";
    pTarget.value = data.target || "";
    pStatus.value = data.status || "";

    document.getElementById("formTitle").innerText = "Edit Project";
    document.getElementById("form").classList.remove("hidden");
  };

  window.deleteProject = async function (id) {
    if (!confirm("Delete this project?")) return;
    await supabaseClient.from("projects").delete().eq("id", id);
    render();
  };

  window.addExpense = async function (projectId) {
    const amount = Number(document.getElementById(`exp-${projectId}`).value);
    const category = document.getElementById(`cat-${projectId}`).value;

    if (!amount || amount <= 0) {
      alert("Enter valid amount");
      return;
    }

    await supabaseClient.from("expenses").insert({
      project_id: projectId,
      amount,
      category
    });

    render();
  };

  window.deleteExpense = async function (expenseId) {
    await supabaseClient.from("expenses").delete().eq("id", expenseId);
    render();
  };

  async function render() {

    document.getElementById("login").classList.add("hidden");
    document.getElementById("ceo").classList.add("hidden");
    document.getElementById("manager").classList.add("hidden");
    document.getElementById("expediter").classList.add("hidden");

    if (!currentRole) return;

    document.getElementById(currentRole).classList.remove("hidden");

    const { data: projects } = await supabaseClient
      .from("projects")
      .select("*")
      .order("created_at", { ascending: true });

    const container =
      currentRole === "ceo" ? ceoProjects :
      currentRole === "manager" ? managerProjects :
      expediterProjects;

    container.innerHTML = "";

    let grandRevenue = 0;
    let grandExpenses = 0;

    for (const p of projects || []) {

      const { data: expenses } = await supabaseClient
        .from("expenses")
        .select("*")
        .eq("project_id", p.id);

      let expensesTotal = 0;
      let expenseHTML = "";

      expenses?.forEach(e => {
        const amount = Number(e.amount) || 0;
        expensesTotal += amount;

        expenseHTML += `
          <div>
            • ${e.category || "Uncategorized"} - ${formatPeso(amount)}
            ${currentRole === "expediter"
              ? `<button onclick="deleteExpense('${e.id}')">Delete</button>`
              : ""}
          </div>
        `;
      });

      const revenue = Number(p.budget) || 0;
      const profit = revenue - expensesTotal;
      const margin = revenue > 0 ? ((profit / revenue) * 100).toFixed(2) : 0;

      grandRevenue += revenue;
      grandExpenses += expensesTotal;

      container.innerHTML += `
        <div class="card">
          <strong>${p.name}</strong><br><br>
          Location: ${p.location || "-"}<br>
          Start: ${p.start || "-"}<br>
          Target: ${p.target || "-"}<br>
          Status: ${p.status || "-"}<br><br>

          Revenue: ${formatPeso(revenue)}<br>
          Total Expenses: ${formatPeso(expensesTotal)}<br>
          Profit: <span class="${profit < 0 ? 'negative' : 'positive'}">${formatPeso(profit)}</span><br>
          Margin: <span class="${margin < 0 ? 'negative' : 'positive'}">${margin}%</span>
          <hr>

          ${expenseHTML || "No expenses yet"}

          ${currentRole === "manager" ? `
            <hr>
            <button onclick="editProject('${p.id}')">Edit</button>
            <button onclick="deleteProject('${p.id}')">Delete</button>
          ` : ""}

          ${currentRole === "expediter" ? `
            <hr>
            <select id="cat-${p.id}">
              <option value="Materials">Materials</option>
              <option value="Labor">Labor</option>
              <option value="Transport">Transport</option>
              <option value="Equipment">Equipment</option>
              <option value="Misc">Misc</option>
            </select>
            <input id="exp-${p.id}" type="number" placeholder="Expense Amount">
            <button onclick="addExpense('${p.id}')">Add Expense</button>
          ` : ""}
        </div>
      `;
    }

    if (currentRole === "ceo") {
      const grandProfit = grandRevenue - grandExpenses;
      const overallMargin = grandRevenue > 0
        ? ((grandProfit / grandRevenue) * 100).toFixed(2)
        : 0;

      ceoSummary.innerHTML = `
        <div class="card">
          <h3>Company Overview</h3>
          Total Revenue: ${formatPeso(grandRevenue)}<br>
          Total Expenses: ${formatPeso(grandExpenses)}<br>
          Net Profit: <span class="${grandProfit < 0 ? 'negative' : 'positive'}">${formatPeso(grandProfit)}</span><br>
          Overall Margin: <span class="${overallMargin < 0 ? 'negative' : 'positive'}">${overallMargin}%</span>
        </div>
      `;
    }
  }

  function clearForm() {
    pName.value = "";
    pLocation.value = "";
    pBudget.value = "";
    pStart.value = "";
    pTarget.value = "";
    pStatus.value = "";
  }

  loadUser();
});
</script>

</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Project Monitoring System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: Arial; background:#f2f4f7; padding:20px; }
    .hidden { display:none; }
    .card { background:#fff; padding:15px; margin-bottom:10px; border-left:5px solid #0d6efd; }
    button { padding:8px 12px; margin:5px 0; }
    input, select { width:100%; padding:6px; margin-bottom:8px; }
  </style>
</head>
<body>

<div id="login">
  <h2>Login</h2>
  <input id="email" type="email" placeholder="Email" />
  <input id="password" type="password" placeholder="Password" />
  <button onclick="login()">Login</button>
</div>

<div id="ceo" class="hidden">
  <h2>CEO Dashboard</h2>
  <button onclick="logout()">Logout</button>
  <div id="ceoProjects"></div>
</div>

<div id="manager" class="hidden">
  <h2>Manager Dashboard</h2>
  <button onclick="logout()">Logout</button>
  <div id="managerProjects"></div>
  <button onclick="showForm()">Create Project</button>
</div>

<div id="expediter" class="hidden">
  <h2>Expediter Dashboard</h2>
  <button onclick="logout()">Logout</button>
  <div id="expediterProjects"></div>
</div>

<div id="form" class="hidden">
  <h3>Create Project</h3>
  <input id="pName" placeholder="Project Name" />
  <input id="pLocation" placeholder="Location" />
  <input id="pBudget" type="number" placeholder="Budget" />
  <input id="pStart" type="date" />
  <input id="pTarget" type="date" />
  <input id="pStatus" placeholder="Status" />
  <button onclick="saveProject()">Save</button>
</div>

<script>
window.addEventListener("load", function () {

  const supabaseClient = window.supabase.createClient(
    "https://qybnvniuifdbxyhyjarn.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5Ym52bml1aWZkYnh5aHlqYXJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NDQ2MTQsImV4cCI6MjA4NjMyMDYxNH0.gr7LlCjcJjs57FiSSiwXY05YB8xZms-RG9iHvg98K1o"
  );

  // ---------------- LOGIN ----------------
  window.login = async function () {
    const { error } = await supabaseClient.auth.signInWithPassword({
      email: email.value,
      password: password.value
    });

    if (error) {
      alert(error.message);
    }
  };

  // Wait for auth session properly
  supabaseClient.auth.onAuthStateChange((event, session) => {
    if (session) {
      render();
    }
  });

  window.logout = async function () {
    await supabaseClient.auth.signOut();
    location.reload();
  };

  window.showForm = function () {
    form.classList.remove("hidden");
  };

  window.saveProject = async function () {
    await supabaseClient.from("projects").insert({
      name: pName.value,
      location: pLocation.value,
      budget: pBudget.value || 0,
      start: pStart.value,
      target: pTarget.value,
      status: pStatus.value || "active"
    });
    form.classList.add("hidden");
  };

  window.addExpense = async function (projectId) {
    const amount = Number(document.getElementById(`exp-${projectId}`).value);
    const category = document.getElementById(`cat-${projectId}`).value;
    if (!amount) return;

    await supabaseClient.from("expenses").insert({
      project_id: projectId,
      amount: amount,
      category: category
    });
  };

  async function getRole(userId) {
    const { data } = await supabaseClient
      .from("profiles")
      .select("role")
      .eq("id", userId)
      .single();
    return data?.role;
  }

  async function render() {

    login.classList.add("hidden");
    ceo.classList.add("hidden");
    manager.classList.add("hidden");
    expediter.classList.add("hidden");

    const { data } = await supabaseClient.auth.getUser();
    const user = data?.user;

    if (!user) {
      login.classList.remove("hidden");
      return;
    }

    const role = await getRole(user.id);
    document.getElementById(role).classList.remove("hidden");

    const { data: projects } = await supabaseClient
      .from("projects")
      .select("*")
      .order("created_at", { ascending: true });

    if (role === "ceo") {

      let totalBudget = 0;
      let totalExpenses = 0;
      let active = 0;
      let completed = 0;

      for (const p of projects) {
        totalBudget += Number(p.budget || 0);
        if (p.status?.toLowerCase() === "completed") completed++;
        else active++;

        const { data: expenses } = await supabaseClient
          .from("expenses")
          .select("amount")
          .eq("project_id", p.id);

        expenses?.forEach(e => totalExpenses += Number(e.amount));
      }

      const remaining = totalBudget - totalExpenses;

      ceoProjects.innerHTML = `
        <div class="card">
          <strong>Company Summary</strong><br><br>
          Total Projects: ${projects.length}<br>
          Total Budget: ${totalBudget}<br>
          Total Expenses: ${totalExpenses}<br>
          Remaining: ${remaining}<br>
          Active: ${active}<br>
          Completed: ${completed}
        </div>
      `;

      projects.forEach(p => {
        ceoProjects.innerHTML += `
          <div class="card">
            <strong>${p.name}</strong><br>
            Location: ${p.location || "-"}<br>
            Budget: ${p.budget || 0}<br>
            Start: ${p.start || "-"}<br>
            Target: ${p.target || "-"}<br>
            Status: ${p.status || "-"}
          </div>
        `;
      });
    }

    if (role === "manager") {
      managerProjects.innerHTML = "";
      projects.forEach(p => {
        managerProjects.innerHTML += `
          <div class="card">
            <strong>${p.name}</strong><br>
            Budget: ${p.budget}
          </div>`;
      });
    }

    if (role === "expediter") {
      expediterProjects.innerHTML = "";
      for (const p of projects) {
        const { data: expenses } = await supabaseClient
          .from("expenses")
          .select("*")
          .eq("project_id", p.id);

        let total = 0;
        expenses?.forEach(e => total += Number(e.amount));

        expediterProjects.innerHTML += `
          <div class="card">
            ${p.name}<br>
            Budget: ${p.budget}<br>
            Total: ${total}<br>
            Remaining: ${p.budget - total}<br>
            <input id="cat-${p.id}" placeholder="Category">
            <input id="exp-${p.id}" type="number" placeholder="Expense">
            <button onclick="addExpense('${p.id}')">Add</button>
          </div>`;
      }
    }
  }

  // REALTIME
  supabaseClient
    .channel("projects-live")
    .on("postgres_changes",
      { event: "*", schema: "public", table: "projects" },
      () => render()
    )
    .subscribe();

  supabaseClient
    .channel("expenses-live")
    .on("postgres_changes",
      { event: "*", schema: "public", table: "expenses" },
      () => render()
    )
    .subscribe();

  render();
});
</script>

</body>
</html>

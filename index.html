<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Project Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: Arial; background:#f2f4f7; padding:20px; }
    .hidden { display:none; }
    .card { background:#fff; padding:15px; margin-bottom:15px; border-left:5px solid #0d6efd; }
    button { padding:6px 10px; margin:4px 2px; }
    input, select { width:100%; padding:6px; margin-bottom:8px; }
    .negative { color:red; font-weight:bold; }
    .positive { color:green; font-weight:bold; }
    .expense { font-size:14px; margin-left:10px; }
    .details { font-size:14px; margin-top:5px; color:#555; }
    .summary { background:#fff; padding:15px; margin-bottom:20px; border-left:5px solid #198754; }
  </style>
</head>
<body>

<div id="login">
  <h2>Login</h2>
  <input id="email" type="email" placeholder="Email" />
  <input id="password" type="password" placeholder="Password" />
  <button onclick="login()">Login</button>
  <p id="error" style="color:red;"></p>
</div>

<div id="ceo" class="hidden">
  <h2>CEO Dashboard</h2>
  <button onclick="logout()">Logout</button>
  <div id="ceoSummary"></div>
  <div id="ceoProjects"></div>
</div>

<div id="manager" class="hidden">
  <h2>Manager Dashboard</h2>
  <button onclick="logout()">Logout</button>
  <button onclick="showForm()">Create Project</button>
  <div id="managerProjects"></div>
</div>

<div id="expediter" class="hidden">
  <h2>Expediter Dashboard</h2>
  <button onclick="logout()">Logout</button>
  <div id="expediterProjects"></div>
</div>

<div id="form" class="hidden">
  <h3 id="formTitle">Create Project</h3>
  <input id="pName" placeholder="Project Name (Required)" />
  <input id="pLocation" placeholder="Location" />
  <input id="pBudget" type="number" placeholder="Project Revenue (Contract Value)" />
  <input id="pStart" type="date" />
  <input id="pTarget" type="date" />
  <input id="pStatus" placeholder="Status" />
  <button onclick="saveProject()">Save</button>
</div>

<script>
window.addEventListener("load", function () {

  const supabaseClient = window.supabase.createClient(
    "https://qybnvniuifdbxyhyjarn.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5Ym52bml1aWZkYnh5aHlqYXJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NDQ2MTQsImV4cCI6MjA4NjMyMDYxNH0.gr7LlCjcJjs57FiSSiwXY05YB8xZms-RG9iHvg98K1o"
  );

  let currentRole = null;
  let editId = null;

  window.login = async function () {
    const { error } = await supabaseClient.auth.signInWithPassword({
      email: email.value,
      password: password.value
    });
    if (error) {
      document.getElementById("error").innerText = error.message;
      return;
    }
    loadUser();
  };

  window.logout = async function () {
    await supabaseClient.auth.signOut();
    location.reload();
  };

  async function loadUser() {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) {
      document.getElementById("login").classList.remove("hidden");
      return;
    }

    const { data } = await supabaseClient
      .from("profiles")
      .select("role")
      .eq("id", user.id)
      .single();

    currentRole = data.role;
    render();
  }

  window.showForm = function () {
    editId = null;
    clearForm();
    document.getElementById("formTitle").innerText = "Create Project";
    document.getElementById("form").classList.remove("hidden");
  };

  window.saveProject = async function () {
    if (!pName.value.trim()) {
      alert("Project name is required");
      return;
    }

    const payload = {
      name: pName.value.trim(),
      location: pLocation.value || null,
      budget: pBudget.value || null,
      start: pStart.value || null,
      target: pTarget.value || null,
      status: pStatus.value || null
    };

    if (editId !== null) {
      await supabaseClient.from("projects").update(payload).eq("id", editId);
      editId = null;
    } else {
      await supabaseClient.from("projects").insert(payload);
    }

    document.getElementById("form").classList.add("hidden");
    clearForm();
    render();
  };

  window.editProject = async function (id) {
    const { data } = await supabaseClient
      .from("projects")
      .select("*")
      .eq("id", id)
      .single();

    editId = id;
    pName.value = data.name || "";
    pLocation.value = data.location || "";
    pBudget.value = data.budget || "";
    pStart.value = data.start || "";
    pTarget.value = data.target || "";
    pStatus.value = data.status || "";

    document.getElementById("formTitle").innerText = "Edit Project";
    document.getElementById("form").classList.remove("hidden");
  };

  window.deleteProject = async function (id) {
    if (!confirm("Delete this project?")) return;
    await supabaseClient.from("projects").delete().eq("id", id);
    render();
  };

  window.addExpense = async function (projectId) {
    const amount = Number(document.getElementById(`exp-${projectId}`).value);
    const category = document.getElementById(`cat-${projectId}`).value;
    if (!amount) return;

    await supabaseClient.from("expenses").insert({
      project_id: projectId,
      amount,
      category
    });

    render();
  };

  window.deleteExpense = async function (expenseId) {
    await supabaseClient.from("expenses").delete().eq("id", expenseId);
    render();
  };

  async function render() {

    document.getElementById("login").classList.add("hidden");
    document.getElementById("ceo").classList.add("hidden");
    document.getElementById("manager").classList.add("hidden");
    document.getElementById("expediter").classList.add("hidden");

    if (!currentRole) {
      document.getElementById("login").classList.remove("hidden");
      return;
    }

    document.getElementById(currentRole).classList.remove("hidden");

    const { data: projects } = await supabaseClient
      .from("projects")
      .select("*")
      .order("created_at", { ascending: true });

    let totalProjects = projects?.length || 0;
    let grandRevenue = 0;
    let grandExpenses = 0;

    const container =
      currentRole === "ceo" ? ceoProjects :
      currentRole === "manager" ? managerProjects :
      expediterProjects;

    container.innerHTML = "";

    for (const p of projects || []) {

      const { data: expenses } = await supabaseClient
        .from("expenses")
        .select("*")
        .eq("project_id", p.id);

      let expensesTotal = 0;
      let expenseHTML = "";

      expenses?.forEach(e => {
        expensesTotal += Number(e.amount);
        expenseHTML += `
          <div class="expense">
            â€¢ ${e.category || "Uncategorized"} - ${e.amount}
            ${currentRole === "expediter"
              ? `<button onclick="deleteExpense('${e.id}')">Delete</button>`
              : ""}
          </div>
        `;
      });

      const revenue = Number(p.budget) || 0;
      const profit = revenue - expensesTotal;

      const marginPercent = revenue > 0
        ? ((profit / revenue) * 100).toFixed(2)
        : 0;

      grandRevenue += revenue;
      grandExpenses += expensesTotal;

      container.innerHTML += `
        <div class="card">
          <strong>${p.name}</strong>
          <div class="details">
            Location: ${p.location || "-"} <br>
            Start: ${p.start || "-"} <br>
            Target: ${p.target || "-"} <br>
            Status: ${p.status || "-"}
          </div>
          <br>
          Revenue: ${revenue}<br>
          Total Expenses: ${expensesTotal}<br>
          Profit:
          <span class="${profit < 0 ? 'negative' : 'positive'}">
            ${profit}
          </span>
          <br>
          Margin:
          <span class="${marginPercent < 0 ? 'negative' : 'positive'}">
            ${marginPercent}%
          </span>
          <hr>
          ${expenseHTML || "No expenses yet"}
          ${currentRole === "expediter" ? `
            <hr>
            <select id="cat-${p.id}">
              <option value="Materials">Materials</option>
              <option value="Labor">Labor</option>
              <option value="Transport">Transport</option>
              <option value="Equipment">Equipment</option>
              <option value="Misc">Misc</option>
            </select>
            <input id="exp-${p.id}" type="number" placeholder="Expense Amount">
            <button onclick="addExpense('${p.id}')">Add Expense</button>
          ` : ""}
          ${currentRole === "manager" ? `
            <hr>
            <button onclick="editProject('${p.id}')">Edit</button>
            <button onclick="deleteProject('${p.id}')">Delete</button>
          ` : ""}
        </div>
      `;
    }

    if (currentRole === "ceo") {

      const grandProfit = grandRevenue - grandExpenses;

      const companyMargin = grandRevenue > 0
        ? ((grandProfit / grandRevenue) * 100).toFixed(2)
        : 0;

      document.getElementById("ceoSummary").innerHTML = `
        <div class="summary">
          <strong>Company Summary</strong><br><br>
          Total Projects: ${totalProjects}<br>
          Total Revenue: ${grandRevenue}<br>
          Total Expenses: ${grandExpenses}<br>
          Total Profit:
          <span class="${grandProfit < 0 ? 'negative' : 'positive'}">
            ${grandProfit}
          </span>
          <br><br>
          Company Margin:
          <span class="${companyMargin < 0 ? 'negative' : 'positive'}">
            ${companyMargin}%
          </span>
        </div>
      `;
    }
  }

  function clearForm() {
    pName.value = "";
    pLocation.value = "";
    pBudget.value = "";
    pStart.value = "";
    pTarget.value = "";
    pStatus.value = "";
  }

  loadUser();
});
</script>

</body>
</html>
